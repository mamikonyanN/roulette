<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @keyframes dissolve {
            0% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }

        .dissolve {
            animation: dissolve .5s forwards;
        }

        .appear {
            animation: dissolve .5s reverse;
        }

        .over {
            position: absolute;
            left: 250px;
            top: 227px;
            transform: translate(-50%, -50%);
        }

        .status {
            position: relative;
            width: 500px;
            height: 35px;
            background: black;
            margin-bottom: 20px;
        }

        .status .bar {
            position: absolute;
            height: 35px;
            width: 0;
            transition: width 1s;
            background: url("./media/bar.png") no-repeat center center;
            background-size: cover;
        }

        .status .current {
            color: white;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-family: "Monly Lite", serif;
            font-weight: bold;
            font-size: 30px;
        }

        .message {
            margin-top: 20px;
            width: 500px;
            min-height: 50px;
            background: black;
            font-family: "Monly Lite", serif;
            font-weight: bold;
            font-size: 30px;
            text-align: center;
            vertical-align: middle;
            color: white;
            border: 10px solid;
            border-image: url("./media/bar.png") 10 round round;
        }
    </style>
    <meta charset="UTF-8">
    <title>Roulette</title>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
</head>
<body style="background: #00ff00">
<div class="status">
    <div class="bar"></div>
    <span class="current" id="current"></span>
</div>
<div id="roulette" style="position: relative">
    <canvas id="canvas" width="500" height="500"></canvas>
    <img src="../media/raptor.png" width="210" class="over" alt="">
</div>
<div class="message">
</div>
<img src="../media/back.jpeg" id="back" hidden alt="">
<script>

    let options = ["default"];
    let socket = new WebSocket(`ws://localhost:${parseInt(location.port) + 1}`);
    socket.onopen = function () {
        console.log("Соединение установлено.");
        socket.send("wgc");
    };
    socket.onclose = function (event) {
        if (event.wasClean) console.log('Соединение закрыто чисто'); else console.log('Обрыв соединения');
        console.log('Код: ' + event.code + '\nпричина: ' + event.reason);
    };
    socket.onerror = function (error) {
        console.log("Ошибка " + error.message);
    };

    socket.onmessage = function (event) {
        let data = JSON.parse(event.data);

        if (data.wishes && data.wishes.length > 0) options = data.wishes;

        if (data.current) document.getElementById("current").innerText = data.current;

        if (data.goal && data.current)
            document.getElementsByClassName("bar")[0].style.width = data.current * 100 / data.goal + "%";

        if (data.spin){
            spinAngleStart = data.spinAngle;
            spinTimeTotal = data.spinTime;
            spin(data.username);
        }

        if (data.e) console.log();
    };

    let spinRemained = [];

    let startAngle = 0;
    let spinTimeout = null;

    let spinAngleStart = 10;
    let spinTime = 0;
    let spinTimeTotal = 0;

    let outsideRadius = 247;
    let textRadius = 170;
    let insideRadius = 100;
    let isSpinning = false;
    let ctx, arc;

    function drawRouletteWheel() {
        arc = Math.PI / (options.length / 2);
        const img = document.getElementById("back");
        let canvas = document.getElementById("canvas");
        if (canvas.getContext) {
            ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, 500, 500);

            ctx.strokeStyle = "white";
            ctx.lineWidth = 3;
            ctx.font = 'bold 30px Monly Lite, Arial';

            let tempCanvas = document.createElement("canvas"), tCtx = tempCanvas.getContext("2d");
            tempCanvas.width = 500;
            tempCanvas.height = 500;
            tCtx.translate(250, 250);
            tCtx.rotate(startAngle + arc / 2 + Math.PI / 2);
            tCtx.drawImage(img, -250, -250, 500, 500);
            tCtx.rotate(-(startAngle + arc / 2 + Math.PI / 2));
            tCtx.translate(-250, -250);

            for (let i = 0; i < options.length; i++) {
                let angle = startAngle + i * arc;

                ctx.fillStyle = ctx.createPattern(tempCanvas, 'no-repeat');
                ctx.strokeStyle = "white";
                // ctx.strokeStyle = "gold";
                ctx.beginPath();
                ctx.arc(250, 250, outsideRadius, angle, angle + arc, false);
                ctx.arc(250, 250, insideRadius, angle + arc, angle, true);
                ctx.fill();
                ctx.stroke();
                ctx.save();

                ctx.fillStyle = "white";
                // ctx.fillStyle = "gold";
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                ctx.shadowBlur = 3;
                ctx.shadowColor = "black";
                ctx.translate(250 + Math.cos(angle + arc / 2) * textRadius,
                    250 + Math.sin(angle + arc / 2) * textRadius);
                ctx.rotate(angle + arc / 2 + Math.PI / 2);
                let text = i + 1;
                ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
                ctx.restore();
            }

            //Arrow
            ctx.fillStyle = "white";
            ctx.beginPath();
            ctx.moveTo(250 - 4, 250 - (outsideRadius + 5));
            ctx.lineTo(250 + 4, 250 - (outsideRadius + 5));
            ctx.lineTo(250 + 4, 250 - (outsideRadius - 5));
            ctx.lineTo(250 + 9, 250 - (outsideRadius - 5));
            ctx.lineTo(250 + 0, 250 - (outsideRadius - 13));
            ctx.lineTo(250 - 9, 250 - (outsideRadius - 5));
            ctx.lineTo(250 - 4, 250 - (outsideRadius - 5));
            ctx.lineTo(250 - 4, 250 - (outsideRadius + 5));
            ctx.fill();
        }
    }

    function spin() {
        if (isSpinning) {
            spinRemained.push("");
            return;
        }
        isSpinning = true;
        spinTime = 0;
        rotateWheel();
    }

    function rotateWheel() {
        spinTime += 50;
        if (spinTime >= spinTimeTotal) {
            stopRotateWheel();
            return;
        }
        let spinAngle = spinAngleStart - easeOut(spinTime, 0, spinAngleStart, spinTimeTotal);
        startAngle += (spinAngle * Math.PI / 180);
        drawRouletteWheel();
        spinTimeout = setTimeout(() => rotateWheel(), 0);
    }

    function stopRotateWheel() {
        clearTimeout(spinTimeout);
        let degrees = startAngle * 180 / Math.PI + 90;
        let arcd = arc * 180 / Math.PI;
        let index = Math.floor((360 - degrees % 360) / arcd);
        ctx.save();
        ctx.restore();
        document.getElementsByClassName('message')[0].innerText = options[index];
        window.speechSynthesis.speak(new SpeechSynthesisUtterance(options[index]));
        isSpinning = false;
        if (spinRemained.length > 0) {
            spin(spinRemained.shift());
        }
    }

    function easeOut(t, b, c, d) {
        let ts = (t /= d) * t;
        let tc = ts * t;
        return b + c * (tc + -3 * ts + 3 * t);
    }

</script>
</body>
</html>
